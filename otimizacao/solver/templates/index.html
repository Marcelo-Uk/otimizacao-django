<!DOCTYPE html>
<html>
<head>
    <title>Otimização Linear</title>
    <style>
        .section { margin-bottom: 20px; }
        .section h3 { margin-bottom: 10px; }
        .variable, .constraint { margin-bottom: 10px; }
        .variable input, .constraint input, .constraint select {
            margin-right: 10px;
        }
        textarea {
            width: 100%;
            height: 50px;
            margin-bottom: 10px;
        }
        #graphSection {
            margin-top: 30px;
            display: none;
        }
        #graph-image {
            width: 100%;
            max-width: 600px;
            border: 1px solid #ddd;
        }
        .constraint {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .constraint button {
            background: red;
            color: white;
            border: none;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Otimização Linear</h1>
    
    <!-- Função Objetivo -->
    <div class="section">
        <h3>Função Objetivo</h3>
        <label>
            Tipo:
            <select id="objectiveType">
                <option value="maximize">Maximizar</option>
                <option value="minimize">Minimizar</option>
            </select>
        </label>
        <br>
        <textarea id="objectiveFunction" placeholder="Exemplo: 2x1 + 3x2"></textarea>
    </div>
    
    <!-- Restrições -->
    <div class="section">
        <h3>Restrições</h3>
        <div id="constraints">
            <div class="constraint">
                <input type="text" placeholder="Exemplo: x1 + x2 <= 10" class="con-restriction">
            </div>
        </div>
        <button onclick="addConstraint()">+ Adicionar Restrição</button>
    </div>
    
    <!-- Botão para Resolver -->
    <div class="section">
        <button onclick="fetchResults()">Resolver</button>
    </div>

    <!-- Pontos das Restrições -->
    <div class="section">
        <h3>Pontos das Restrições:</h3>
        <pre id="restrictionPoints"></pre>
    </div>
    
    <!-- Resultados -->
    <div class="section">
        <h2>Resultados:</h2>
        <pre id="result"></pre>
    </div>
    
    <!-- Gráfico da Solução (MATPLOTLIB) -->
    <div class="section" id="graphSection">
        <h2>Gráfico da Solução:</h2>
        <img id="graph-image" src="" alt="Gráfico da Solução">
    </div>

    {% csrf_token %}
    
    <script>
        /**
         * Adiciona uma nova restrição ao formulário.
         */
        function addConstraint() {
            const div = document.createElement('div');
            div.className = 'constraint';
            div.innerHTML = `
                <input type="text" placeholder="Exemplo: x1 + x2 <= 10" class="con-restriction">
                <button onclick="removeConstraint(this)">Remover</button>
            `;
            document.getElementById('constraints').appendChild(div);
        }

        /**
         * Remove uma restrição específica do formulário.
         */
        function removeConstraint(button) {
            button.parentElement.remove();
        }

        /**
         * Obtém o CSRF Token dos cookies.
         */
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length, cookie.length);
                }
            }
            return null;
        }

        /**
         * Oculta o gráfico quando há alterações nos campos.
         */
        function hideGraph() {
            document.getElementById('graphSection').style.display = 'none';
        }

        document.getElementById('objectiveFunction').addEventListener('input', hideGraph);
        document.querySelectorAll('.con-restriction').forEach(el => el.addEventListener('input', hideGraph));

        /**
         * Envia os dados para o backend e exibe os resultados.
         */
        async function fetchResults() {
            const objective = document.getElementById('objectiveType').value;
            const objectiveFunction = document.getElementById('objectiveFunction').value;

            const constraints = Array.from(document.querySelectorAll('.con-restriction'))
                .map(el => el.value);

            const data = {
                objective,
                objectiveFunction,
                constraints
            };
        
            try {
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    alert('CSRF Token não encontrado! Certifique-se de que os cookies estão habilitados.');
                    return;
                }
            
                const response = await fetch('/solver/optimize/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
            
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Erro: ${errorData.error}`);
                    return;
                }
            
                const result = await response.json();
            
                // Atualiza resultados
                document.getElementById('result').innerHTML = `
                    <strong>Ponto Ótimo:</strong> ${result['Ponto Ótimo']}<br>
                    <strong>Resultado Objetivo:</strong> ${result['Resultado Objetivo']}
                `;
            
                // Atualiza pontos das restrições
                document.getElementById('restrictionPoints').innerHTML = result['Pontos Restrição']
                    .map(r => `${r['Restrição']}: (${r['Pontos'][0][0]}, ${r['Pontos'][0][1]}) → (${r['Pontos'][1][0]}, ${r['Pontos'][1][1]})`)
                    .join('<br>');
            
                // Atualiza gráfico
                document.getElementById('graph-image').src = result['graph_path'] + '?t=' + new Date().getTime();
                document.getElementById('graphSection').style.display = 'block';
            } catch (error) {
                console.error('Erro ao processar a solicitação:', error);
                alert('Erro inesperado. Verifique o console para mais detalhes.');
            }
        }
    </script>
</body>
</html>
