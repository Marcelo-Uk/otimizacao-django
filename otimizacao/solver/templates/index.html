<!DOCTYPE html>
<html>
<head>
    <title>Otimização Linear</title>
    <style>
        .section { margin-bottom: 20px; }
        .section h3 { margin-bottom: 10px; }
        .variable, .constraint { margin-bottom: 10px; }
        .variable input, .constraint input, .constraint select {
            margin-right: 10px;
        }
        textarea {
            width: 100%;
            height: 50px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Otimização Linear</h1>
    
    <!-- Função Objetivo -->
    <div class="section">
        <h3>Função Objetivo</h3>
        <label>
            Tipo:
            <select id="objectiveType">
                <option value="maximize">Maximizar</option>
                <option value="minimize">Minimizar</option>
            </select>
        </label>
        <br>
        <textarea id="objectiveFunction" placeholder="Exemplo: 2x1 + 3x2"></textarea>
    </div>
    
    <!-- Restrições -->
    <div class="section">
        <h3>Restrições</h3>
        <div id="constraints">
            <div class="constraint">
                <input type="text" placeholder="Exemplo: x1 + x2 <= 10" class="con-restriction">
            </div>
        </div>
        <button onclick="addConstraint()">+ Adicionar Restrição</button>
    </div>
    
    <!-- Botão para Resolver -->
    <div class="section">
        <button onclick="fetchResults()">Resolver</button>
    </div>
    
    <!-- Resultados -->
    <div class="section">
        <h2>Resultados:</h2>
        <pre id="result"></pre>
    </div>
    
    <!-- Gráfico da Solução (MATPLOTLIB)
    <div class="section" id="graph-section" style="display: none;">
        <h2>Gráfico da Solução:</h2>
        <img id="graph-image" src="" alt="Gráfico da Solução">
    </div>
    -->

    <!-- Gráfico da Solução (PLOTLY) -->
    <div class="section" id="graphSection" style="display: none;">
        <h2>Gráfico da Solução:</h2>
        <iframe id="graphFrame" src="" width="100%" height="500px" frameborder="0"></iframe>
    </div>
    

    {% csrf_token %}
    
    <script>

        document.getElementById('restrictionPoints').innerHTML = result['Pontos Restrição']
            .map(r => `${r['Restrição']}: (${r['Pontos'][0][0]}, ${r['Pontos'][0][1]}) → (${r['Pontos'][1][0]}, ${r['Pontos'][1][1]})`)
            .join('<br>');

        function hideGraph() {
            document.getElementById('graphSection').style.display = 'none';
        }
        document.getElementById('objectiveFunction').addEventListener('input', hideGraph);
        document.querySelectorAll('.con-restriction').forEach(el => el.addEventListener('input', hideGraph));


        function addConstraint() {
            const div = document.createElement('div');
            div.className = 'constraint';
            div.innerHTML = `
                <input type="text" placeholder="Exemplo: x1 + x2 <= 10" class="con-restriction">
            `;
            document.getElementById('constraints').appendChild(div);
        }

        function getCSRFToken() {
            // Tenta buscar o token no campo oculto
            const tokenElement = document.getElementById('csrf-token');
            if (tokenElement) {
                return tokenElement.value;
            }
        
            // Tenta buscar nos cookies
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length, cookie.length);
                }
            }
            return null;
        }

        async function fetchResults() {
            const objective = document.getElementById('objectiveType').value;
            const objectiveFunction = document.getElementById('objectiveFunction').value;
            const constraints = Array.from(document.querySelectorAll('.con-restriction'))
                .map(el => el.value);
                
            const data = { objective, objectiveFunction, constraints };
                
            try {
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    alert('CSRF Token não encontrado! Certifique-se de que os cookies estão habilitados.');
                    return;
                }
            
                const response = await fetch('/solver/optimize/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
            
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Erro: ${errorData.error}`);
                    return;
                }
            
                const result = await response.json();
            
                document.getElementById('result').innerHTML = `
                    <strong>Ponto Ótimo:</strong> ${result['Ponto Ótimo']}<br>
                    <strong>Resultado Objetivo:</strong> ${result['Resultado Objetivo']}
                `;
            
                document.getElementById('graphFrame').src = result['graph_path'];
                document.getElementById('graphSection').style.display = 'block';
            } catch (error) {
                console.error('Erro ao processar a solicitação:', error);
                alert('Erro inesperado. Verifique o console para mais detalhes.');
            }
        }

    </script>
</body>
</html>
